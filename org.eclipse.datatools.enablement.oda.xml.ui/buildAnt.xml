<?xml version="1.0"?>
<!--
 *************************************************************************
 * Copyright (c) 2006 Actuate Corporation.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *  Actuate Corporation - initial API and implementation
 *  
 *************************************************************************
 *
 *  buildAnt.xml
 *
 *  Build script for project org.eclipse.datatools.enablement.oda.xml.ui
 *
 *  Usage:
 *    ant [any one or more of the public targets] 
 *        -Declipse.home=<your eclipse home> 
 *		  -Ddtp.home=<your DTP plugins source home>  [optional]
 *
 *  Default target is "build.jars".
 *
 *  Notes:
 *  1. classpath need to be set for junit.jar
 *  2. The build script requires Ant 1.6
 *
-->

<project name="DTP ODA XML Designer Project" default="build.jars" basedir=".">
	<description>DTP ODA XML UI Designer</description>
	<!-- ===== Default value for public properties ============= -->
	<property file="build.properties"/>
	<property name="module.name" value="org.eclipse.datatools.enablement.oda.xml.ui"/>
	<property file="META-INF/MANIFEST.MF" />
	<property name="plugin.version" value="${Bundle-Version}" />
	<property name="plugin.package" value="${module.name}_${plugin.version}" />

	<property name="eclipse.home" location="."/>
	<property name="dtp.home" location=".."/>
	<property name="utest.report.dir" location="utestreports"/>
	<property name="javadoc.dir" location="doc/api"/>
	<property name="export.dir" location="export"/>
	<property name="dir.utest" value="utest"/>
	<property name="dir.src" value="${source..}"/>
	<property name="dir.test" value="test"/>
	<property name="dir.bin" value="${output..}"/>
	<property name="dir.lib" value="lib"/>
	<property name="build.result.dir" location="."/>
	<property name="source.root" location="./src"/>
	<property name="source.xmlui.dir" location="./src/org/eclipse/datatools/enablement/oda/xml/ui/"/>
	<property name="temp.dir" location="./tempdir/"/>

	<property name="dtp.oda.plugin" value="org.eclipse.datatools.connectivity.oda" />
	<property name="dtp.oda.dir" location="${dtp.home}/${dtp.oda.plugin}"/>
	<property name="dtp.oda.profile.plugin" value="org.eclipse.datatools.connectivity.oda.profile" />
	<property name="dtp.oda.profile.dir" location="${dtp.home}/${dtp.oda.profile.plugin}"/>
	<property name="dtp.oda.design.plugin" value="org.eclipse.datatools.connectivity.oda.design" />
	<property name="dtp.oda.design.dir" location="${dtp.home}/${dtp.oda.design.plugin}"/>
	<property name="dtp.oda.design.ui.plugin" value="org.eclipse.datatools.connectivity.oda.design.ui" />
	<property name="dtp.oda.design.ui.dir" location="${dtp.home}/${dtp.oda.design.ui.plugin}"/>
	<property name="dtp.oda.xml.plugin" value="org.eclipse.datatools.enablement.oda.xml" />
	<property name="dtp.oda.xml.dir" location="${dtp.home}/${dtp.oda.xml.plugin}"/>

	<path id="class.path">
		<pathelement path="${dir.bin}"/>
		<fileset dir="${dtp.oda.dir}">
			<include name="oda.jar"/>			
			<include name="download/${dtp.oda.plugin}_*.jar"/>			
		</fileset>
		<fileset dir="${dtp.oda.profile.dir}">
			<include name="odaprofile.jar"/>			
			<include name="download/${dtp.oda.profile.plugin}_*.jar"/>
		</fileset>
		<fileset dir="${dtp.oda.design.dir}">
			<include name="odadesign.jar"/>
			<include name="download/${dtp.oda.design.plugin}_*.jar"/>
		</fileset>
		<fileset dir="${dtp.oda.design.ui.dir}">
			<include name="odadesignui.jar"/>
			<include name="download/${dtp.oda.design.ui.plugin}_*.jar"/>
		</fileset>
		<fileset dir="${dtp.oda.xml.dir}">
			<include name="oda-xml.jar"/>
			<include name="download/${dtp.oda.xml.plugin}_*.jar"/>
		</fileset>
		<!-- Dependencies on other DTP plug-ins, built before this one -->
		<fileset dir="${dtp.home}">
			<include name="org.eclipse.datatools.connectivity.ui/connectivityui.jar"/>
		</fileset>
		<!-- Dependencies on Eclipse installation -->
		<fileset dir="${eclipse.home}/plugins">
			<include name="org.eclipse.ui_*.jar"/>
			<include name="org.eclipse.swt_*.jar"/>
			<include name="org.eclipse.swt.*_*.jar"/>
			<include name="org.eclipse.jface_*.jar"/>
			<include name="org.eclipse.core.commands_*.jar"/>
			<include name="org.eclipse.ui.workbench_*.jar"/>
			<include name="com.ibm.icu_*.jar"/>
			<include name="org.eclipse.emf.ecore_*.jar"/>
			<include name="org.eclipse.emf.common_*.jar"/>
			<include name="org.eclipse.emf.ecore.xmi_*.jar"/>
			<include name="org.eclipse.core.runtime_*.jar"/>
			<include name="org.eclipse.osgi_*.jar"/>
			<include name="org.eclipse.equinox.common_*.jar"/>
			<include name="org.eclipse.core.jobs_*.jar"/>
			<include name="org.eclipse.core.runtime.compatibility.registry_*/runtime_registry_compatibility.jar"/>
			<include name="org.eclipse.equinox.registry_*.jar"/>
			<include name="org.eclipse.equinox.preferences_*.jar"/>
			<include name="org.eclipse.core.contenttype_*.jar"/>
			
			<include name="org.eclipse.datatools.connectivity.ui_*.jar"/>
			<include name="org.eclipse.datatools.connectivity.ui_*/connectivityui.jar"/>
		</fileset>
	</path>

	<!-- Compile source code and generate jar for this project.
		 Input parameters:
		 	eclipse.home
		 	dtp.home
	-->
	<target name="oda-xmlui.jar" depends="compileSource">
		<jar destfile="oda-xmlui.jar">
			<fileset dir="${dir.bin}">
				<include name="**/*.class"/>
				<include name="**/*.txt"/>
				<include name="**/*.xml"/>
				<include name="**/*.def"/>
				<include name="**/*.properties"/>
				<exclude name="**/*Test.class"/>
				<exclude name="**/package.html"/>
			</fileset>
		</jar>
	</target>

	<target name="oda-xmluisrc.zip">
		<mkdir dir="${build.result.dir}"/>
		<zip zipfile="${build.result.dir}/oda-xmluisrc.zip" filesonly="false" whenempty="skip" update="false">
			<fileset dir="${source.root}" excludes="**/*.class"/>
		</zip>
	</target>

	<target name="build.jars" description="Build all the jars for the plug-in.">
		<antcall target="oda-xmlui.jar"/>
	</target>

	<target name="build.source.zips" description="Create zip files containing the source for the plug-in.">
		<antcall target="oda-xmluisrc.zip"/>
	</target>

	<target name="gather.bin.parts" if="destination.temp.folder">
		<mkdir dir="${destination.temp.folder}/${plugin.package}"/>
		<copy todir="${destination.temp.folder}/${plugin.package}" failonerror="true">
			<fileset dir="${build.result.dir}" includes="${bin.includes}"/>
		</copy>
	</target>

	<target name="gather.src.parts" if="destination.temp.folder">
		<mkdir dir="${destination.temp.folder}/${plugin.package}"/>
		<copy todir="${destination.temp.folder}/${plugin.package}" failonerror="false" overwrite="false">
			<fileset dir="${build.result.dir}" includes="oda-xmluisrc.zip"/>
		</copy>
	</target>

	<target name="zip.plugin" description="Create a zip containing the plug-in.">
		<delete dir="${temp.dir}"/>
		<mkdir dir="${temp.dir}"/>
		<antcall target="build.jars"/>
		<antcall target="gather.bin.parts">
			<param name="destination.temp.folder" value="${temp.dir}/"/>
		</antcall>
		<delete>
			<fileset dir="${temp.dir}" includes="**/*.bin.log"/>
		</delete>
		<zip zipfile="${build.result.dir}/${plugin.package}.zip" 
			 basedir="${temp.dir}" 
			 filesonly="true" 
			 whenempty="skip" 
			 update="false"/>
		<delete dir="${temp.dir}"/>
	</target>

	<target name="download.plugin" description="Create a download folder that contains all the files to include in DTP download build.">
		<antcall target="clean"/>
		<antcall target="create.download.dir"/>
		<antcall target="build.jars"/>
		<antcall target="jar.plugin"/>
	</target>

	<target name="jar.plugin" >
		<property file="META-INF/MANIFEST.MF" />
		<property name="jar.name" value="${plugin.package}.jar" />
		<antcall target="create.download.dir"/>
		<jar destfile="${download.dir}/${jar.name}" manifest="./META-INF/MANIFEST.MF">
			<fileset dir="${dir.bin}">
				<include name="**/*.class"/>
				<include name="**/*.txt"/>
				<include name="**/*.xml"/>
				<include name="**/*.def"/>
				<include name="**/*.properties"/>
				<exclude name="**/*Test.class"/>
			</fileset>
			<fileset dir="." includes="${bin.includes}"/>
	    </jar>
	</target>

	<target name="clean.download.dir" unless="dtp.build">
		<delete dir="${download.dir}"/>
	</target>

	<target name="create.download.dir" unless="dtp.build">
		<mkdir dir="${download.dir}"/>
	</target>

	<!-- Clean all objects created by this script -->
	<target name="clean" description="Clean the plug-in of all the zips, jars, and logs created.">
		<!-- Delete the generated L10N messages properties -->
		<delete>
			<fileset dir="${source.xmlui.dir}/i18n" includes="messages_*.properties"/>
			<fileset dir="${build.result.dir}" includes="plugin_*.properties"/>
		</delete>
		<!-- Delete the binary and unit tests directories -->
		<delete dir="${dir.bin}"/>
		<delete dir="${dir.utest}"/>
		<delete dir="${utest.report.dir}"/>
		<delete dir="${javadoc.dir}"/>
		<antcall target="clean.download.dir"/>
		<!-- Delete the target jar and zip files -->
		<delete file="oda-xmlui.jar"/>
		<delete file="${build.result.dir}/oda-xmluisrc.zip"/>
		<delete>
			<fileset dir="${build.result.dir}" includes="${module.name}_*.zip"/>
		</delete>
	</target>

	<!-- Generate the JavaDoc.
		 Parameters:
		 		- ${javadoc.dir} target directory to put the java document
	 -->
	<target name="javadoc" description="Create Javadoc API documentation for this plugin.">
	</target>

	<target name="buildDependency">
		<echo message="Begin call ODA jars task in ${dtp.oda.dir}"/>
		<ant dir="${dtp.oda.dir}" antfile="buildAnt.xml" target="build.jars" inheritAll="false">
			<property name="eclipse.home" value="${eclipse.home}"/>
			<property name="dtp.home" value="${dtp.home}"/>
		</ant>
		<echo message="End call ODA jars task in ${dtp.oda.dir}"/>

		<echo message="Begin call ODA jars task in ${dtp.oda.xml.dir}"/>
		<ant dir="${dtp.oda.xml.dir}" antfile="buildAnt.xml" target="build.jars" inheritAll="false">
			<property name="eclipse.home" value="${eclipse.home}"/>
			<property name="dtp.home" value="${dtp.home}"/>
		</ant>
		<echo message="End call ODA jars task in ${dtp.oda.xml.dir}"/>

</target>

	<target name="compileSource" depends="buildDependency">
		<mkdir dir="${dir.bin}"/>
		<copy todir="${dir.bin}">
			<fileset dir="${dir.src}">
				<include name="**/*.properties"/>
			</fileset>
		</copy>
		<!-- Compile the java code from ${dir.src} into ${dir.bin} -->
		<javac srcdir="${dir.src}" 
			   destdir="${dir.bin}" 
			   encoding="utf-8" 
			   source="1.4" 
			   target="1.4" 
			   includeAntRuntime="no" 
			   debug="true">
			<classpath refid="class.path" />			
		</javac>
	</target>

	<target name="i18n">
		<native2ascii encoding="Cp1252"
					  src="${source.xmlui.dir}/i18n" 
					  dest="${source.xmlui.dir}/i18n" 
					  ext=".properties" 
					  includes="messages_de_DE.msg, messages_es_ES.msg, messages_fr_FR.msg"/>
		<native2ascii encoding="GBK" 
					  src="${source.xmlui.dir}/i18n" 
					  dest="${source.xmlui.dir}/i18n" 
					  ext=".properties" 
					  includes="messages_zh_CN.msg"/>	
		<native2ascii encoding="SJIS" 
					  src="${source.xmlui.dir}/i18n" 
					  dest="${source.xmlui.dir}/i18n" 
					  ext=".properties"
					  includes="messages_ja_JP.msg"/>
		<native2ascii encoding="MS949" 
					  src="${source.xmlui.dir}/i18n" 
					  dest="${source.xmlui.dir}/i18n" 
					  ext=".properties"
					  includes="messages_ko_KR.msg"/>

		<native2ascii encoding="Cp1252"
					  src="${source.xmlui.dir}/i18n" 
					  dest="${build.result.dir}" 
					  ext=".properties" 
					  includes="plugin_de_DE.msg, plugin_es_ES.msg, plugin_fr_FR.msg"/>
		<native2ascii encoding="GBK" 
					  src="${source.xmlui.dir}/i18n" 
					  dest="${build.result.dir}" 
					  ext=".properties" 
					  includes="plugin_zh_CN.msg"/>	
		<native2ascii encoding="SJIS" 
					  src="${source.xmlui.dir}/i18n" 
					  dest="${build.result.dir}" 
					  ext=".properties"
					  includes="plugin_ja_JP.msg"/>
		<native2ascii encoding="MS949" 
					  src="${source.xmlui.dir}/i18n" 
					  dest="${build.result.dir}" 
					  ext=".properties"
					  includes="plugin_ko_KR.msg"/>
	</target>

	<!-- Run unit tests.
			 Parameters:
			 	- ${utest.report.dir} target directory for the junit test output
	-->
	<!-- This public task does not explicitly depend on compileSource; 
		top level script should call build.jars target before calling run.tests -->
	<target name="run.tests" depends="compileTest" description="Run all the unit tests">
	</target>

	<!-- Compile Test Files -->
	<!--  NOTE: must first manually set classpath for junit.jar -->
	<target name="compileTest">
	</target>
	
</project>
